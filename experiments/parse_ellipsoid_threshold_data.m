clear;
files = dir('data_from_cluster/ellipsoid_threshold_data/*.mat');

%% load in all out_structs and test_params
k=1;
for file = files'
    load(strcat('data_from_cluster/ellipsoid_threshold_data/',file.name));
    fprintf(file.name); fprintf('\n');
    
    if isfield(out_struct_max, 'constrained_certified_suboptimality_gap')
        out_structs(k) = out_struct_max;
        test_params(k) = test_param;
        summaries(k) = summary;
        k=k+1;    
    end
end
k=k-1;

% sort the test cases by oblivious_gap so we can diagnose any weird cases
[~,I] = sort([summaries.adversarial_y_nom]);
out_structs = out_structs(I);
test_params = test_params(I);
summaries = summaries(I);

% %%
% figure('Units','inches', ...
%     'Position',[0 0 3.3 3], ...
%     'PaperPositionMode', 'auto');
% 
% adversarial_y_nom = [summaries.adversarial_y_nom];
% adversarial_y_robust = [summaries.adversarial_y_robust];
% 
% max_val = max( max(adversarial_y_nom), max(adversarial_y_robust) );
% 
% plot(adversarial_y_nom, adversarial_y_robust, 'o'); hold on;
% plot(0:0.001:1.1*max_val, 0:0.001:1.1*max_val);
% axis([0 max_val 0 max_val]);
% set(gca,...
%     'Units','normalized',...
%     'YTick',0:0.05:max_val,...
%     'XTick',0:0.05:max_val,...
%     'Position',[.15 .2 .75 .7],...
%     'FontUnits','points',...
%     'FontWeight','normal',...
%     'FontSize',10,...
%     'FontName','Times');
% 
% xlabel('Worst-case influence of $y_{\mathrm{nom}}$',...
%     'FontUnits','points',...
%     'interpreter','latex',...
%     'FontSize',10,...
%     'FontName','Times');
% ylabel('Worst-case influence of $y_{\mathrm{robust}}$',...
%     'FontUnits','points',...
%     'interpreter','latex',...
%     'FontSize',10,...
%     'FontName','Times');
% 
% title({'Robust vs non-robust budgets', 'for ellipsoidal uncertainty'},...
%     'FontUnits','points',...
%     'FontWeight','normal',...
%     'FontSize',10,...
%     'FontName','Times');
% 
% %print -depsc2 ../plots/ellipsoidal-robust-vs-nom.eps

%% diagnostic plot
figure('Units','inches', ...
    'Position',[0 0 3.3 3], ...
    'PaperPositionMode', 'auto');

gammas = [test_params.x_constraint];
% sort the test cases by gammas
[~,I] = sort(gammas);
gammas = gammas(I);
out_structs = out_structs(I);
test_params = test_params(I);
summaries = summaries(I);

adversarial_y_nom = [summaries.adversarial_y_nom];
adversarial_y_robust = [summaries.adversarial_y_robust];
adversarial_y_expect = [summaries.adversarial_y_expect];

max_gamma = max(gammas);
min_gamma = min(gammas);
max_influence = max( [max(adversarial_y_nom), max(adversarial_y_robust), max(adversarial_y_expect)] );



plot(gammas, adversarial_y_robust, '-'); hold on;
plot(gammas, adversarial_y_nom, '-'); hold on;
plot(gammas, adversarial_y_expect, '-');

axis([min_gamma max_gamma 0 max_influence]);
set(gca,...
    'Units','normalized',...
    'YTick',0:0.1:0.65,...%max_influence,...
    'XTick',min_gamma:300:max_gamma,...
    'Position',[.15 .2 .75 .7],...
    'FontUnits','points',...
    'FontWeight','normal',...
    'FontSize',10,...
    'FontName','Times');

xlabel('Adversary constraint $\gamma$',...
    'FontUnits','points',...
    'interpreter','latex',...
    'FontSize',10,...
    'FontName','Times');
ylabel('Worst-case influence',...
    'FontUnits','points',...
    'interpreter','latex',...
    'FontSize',10,...
    'FontName','Times');
legend({'$y_{\mathrm{robust}}$','$y_{\mathrm{nom}}$','$y_{\mathrm{expect}}$'},...
    'FontUnits','points',...
    'interpreter','latex',...
    'FontSize',10,...
    'FontName','Times');


title({'Influence as adversary power changes','for ellipsoidal uncertainty'},...
    'FontUnits','points',...
    'FontWeight','normal',...
    'FontSize',10,...
    'FontName','Times');

%print -depsc2 ../plots/ellipsoidal-robust-vs-nom.eps


%% how well do we do on the 'true' x_centers value?
true_y_nom = zeros(k,1);
true_y_robust = zeros(k,1);
true_y_expect = zeros(k,1);
for ii=1:k
    param_F = submodular_fct_influence_adversary_build_param_from_problem(test_params(ii).problem, test_params(ii).eps);
    x_true_vec = test_params(ii).problem.x_centers_true(test_params(ii).problem.var_edges);
    
    true_y_nom(ii) = submodular_fct_influence_adversary_vec_wrapper(x_true_vec, summaries(ii).y_nom, param_F);
    true_y_robust(ii) = submodular_fct_influence_adversary_vec_wrapper(x_true_vec, summaries(ii).y_robust, param_F);
    true_y_expect(ii) = submodular_fct_influence_adversary_vec_wrapper(x_true_vec, summaries(ii).y_expect, param_F);
end

figure('Units','inches', ...
    'Position',[0 0 3.3 3], ...
    'PaperPositionMode', 'auto');

gammas = [test_params.x_constraint];
max_gamma = max(gammas);
min_gamma = min(gammas);
max_influence = max( [max(true_y_nom), max(true_y_robust), max(true_y_expect)] );

plot(gammas, true_y_robust, '-'); hold on;
plot(gammas, true_y_nom, '-'); hold on;
plot(gammas, true_y_expect, '-');

axis([min_gamma max_gamma 0 max_influence]);
set(gca,...
    'Units','normalized',...
    'YTick',0:0.1:max_influence,...
    'XTick',min_gamma:300:max_gamma,...
    'Position',[.15 .2 .75 .7],...
    'FontUnits','points',...
    'FontWeight','normal',...
    'FontSize',10,...
    'FontName','Times');

xlabel('Adversary constraint $\gamma$',...
    'FontUnits','points',...
    'interpreter','latex',...
    'FontSize',10,...
    'FontName','Times');
ylabel('Worst-case influence',...
    'FontUnits','points',...
    'interpreter','latex',...
    'FontSize',10,...
    'FontName','Times');
legend({'$y_{\mathrm{robust}}$','$y_{\mathrm{nom}}$','$y_{\mathrm{expect}}$'},...
    'location','southwest',...
    'FontUnits','points',...
    'interpreter','latex',...
    'FontSize',10,...
    'FontName','Times');


title({'Robust vs non-robust budgets', 'for ellipsoidal uncertainty', 'as adversary power changes', 'for true influence function'},...
    'FontUnits','points',...
    'FontWeight','normal',...
    'FontSize',10,...
    'FontName','Times');